---
layout: page
title: Test model class
test: true
---

<script src="../public/dist/chartstack2.min.js"></script>
<script>

var data = [
  ["Year", "Sales", "Expenses", "Pizzas"],
  ["2004",  1000,      400,     500],
  ["2005",  1170,      460,     400],
  ["2006",  660,       1120,    300],
  ["2007",  1030,      540,     200]
];

var pieData = [
  ["Browser", "Share"],
  ["Firefox", 45.0],
  ["IE", 26.8],
  ["Chrome", 12.8],
  ["Safari", 8.5],
  ["Opera", 6.2],
  ["Others", 0.7]
];

describe('model: direct injecting JSON data', function(){
  var d = new chartstack.Model({
    data: data
  });

  it('Should have raw data', function(){
    expect(d.data).to.deep.equal(data);
  });

  it('Chartstack model defaults: polling property should be there but false.', function(){
    expect(d.pollInterval).to.equal(0);
  });
});

describe('model: fetch data from url', function(){
  it('Should have properly fetched data', function(done){
    var d = new chartstack.Model({
      url: '/api/universal/piechart.json'
    })

    d.on('update', function(){
      expect(d.data).to.deep.equal(pieData);
      done();
    });
    d.fetch();
  });

  it('Should support .filterRows after fetching data', function(done){
    var d = new chartstack.Model({
      url: '/api/universal/barchart.json'
    })
      .fetch()
      .filterRows(['2004'])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales","Expenses"],
          ["2005", 1170,    460],
          ["2006", 660,     1120],
          ["2007", 1030,    540]
        ]);
        done();
      });
  });
});

describe('model: injecting and polling url data', function(){
  var stopCount;
  var d = new chartstack.Model({
    url: '/api/universal/piechart.json',
    pollInterval: 100
  })
    .filterRows(['Opera', 'Others']);

  it('Should have proper filtered data', function(done){
    d.on('update', function(){
      expect(d.data).to.deep.equal([
        ["Browser", "Share"],
        ["Firefox", 45.0],
        ["IE", 26.8],
        ["Chrome", 12.8],
        ["Safari", 8.5]
      ]);
      done();
    });

    d.fetch();
  });


  it('Should be polling data', function(done){

    d.on('polling', function(){
      var self = this;

      if (this.pollCount = 3){
        this.stopPoll();
        setTimeout(function(){
          expect(self.pollCount).to.equal(3);

          expect(self.data).to.deep.equal([
            ["Browser", "Share"],
            ["Firefox", 45.0],
            ["IE", 26.8],
            ["Chrome", 12.8],
            ["Safari", 8.5]
          ]);
          done();
        },this.pollInterval * 2);
      }
      done();
    });
  });
});

describe('test transforms with inline data', function(){

  it('.filterRows', function(){
    var model = new chartstack.Model({
      data: data
    })
      .filterRows(['2004', '2006']);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2005",  1170,      460,     400],
      ["2007",  1030,      540,     200]
    ]);
  });

  it('.filterRows (before setting data)', function(){
    var model = new chartstack.Model()
      .filterRows(['2004', '2006'])
      .set(data);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2005",  1170,      460,     400],
      ["2007",  1030,      540,     200]
    ]);
  });


  it('.filterColumns', function(){
    var model = new chartstack.Model({
      data: data
    })
      .filterColumns(['Sales', 'Pizzas']);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year",  "Expenses"],
      ["2004",     400],
      ["2005",     460],
      ["2006",     1120],
      ["2007",     540]
    ]);
  });

  it('.filterColumns (before setting data)', function(){
    var model = new chartstack.Model({})
      .filterColumns(['Sales', 'Pizzas'])
      .set(data);

    expect(model.data).to.deep.equal([
      ["Year",  "Expenses"],
      ["2004",     400],
      ["2005",     460],
      ["2006",     1120],
      ["2007",     540]
    ]);
  });

  it('.onlyRows', function(){
    var model = new chartstack.Model({
      data: data
    })
      .onlyRows(['2004', '2006'])

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2004",  1000,      400,     500],
      ["2006",  660,       1120,    300]
    ]);
  });

  it('.onlyRows (before setting data)', function(){
    var model = new chartstack.Model({})
      .onlyRows(['2004', '2006'])
      .set(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2004",  1000,      400,     500],
      ["2006",  660,       1120,    300]
    ]);
  });

  it('.onlyColumns', function(){
    var model = new chartstack.Model({
      data: data
    })
      .onlyColumns(['Sales', 'Pizzas']);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales",  "Pizzas"],
      ["2004",  1000,    500],
      ["2005",  1170,    400],
      ["2006",  660,     300],
      ["2007",  1030,    200]
    ]);
  });

  it('.sortColumns', function(){
    var model = new chartstack.Model({
      data: data
    })
      .sortColumns(['Pizzas', 'Expenses', 'Sales']);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year",  "Pizzas", "Expenses", "Sales"],
      ["2004",  500,    400,      1000],
      ["2005",  400,    460,      1170],
      ["2006",  300,    1120,     660],
      ["2007",  200,    540,      1030]
    ]);
  });

  it('.onlyColumns (before setting data)', function(){
    var model = new chartstack.Model()
      .onlyColumns(['Sales', 'Pizzas'])
      .set(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales",  "Pizzas"],
      ["2004",  1000,    500],
      ["2005",  1170,    400],
      ["2006",  660,     300],
      ["2007",  1030,    200]
    ]);
  });

  it('.addRows', function(){
    var model = new chartstack.Model({
      data: data
    })
      .addRows([
        ['2008', 100, 200, 300],
        ['2009', 200, 300, 400]
      ]);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2004",  1000,      400,     500],
      ["2005",  1170,      460,     400],
      ["2006",  660,       1120,    300],
      ["2007",  1030,      540,     200],
      ['2008',  100,       200,     300],
      ['2009',  200,       300,     400]
    ]);
  });

  it('.addRows (before setting data)', function(){
    var model = new chartstack.Model({})
      .addRows([
        ['2008', 100, 200, 300],
        ['2009', 200, 300, 400]
      ])
      .set(data);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas"],
      ["2004",  1000,      400,     500],
      ["2005",  1170,      460,     400],
      ["2006",  660,       1120,    300],
      ["2007",  1030,      540,     200],
      ['2008',  100,       200,     300],
      ['2009',  200,       300,     400]
    ]);
  });

  it('.addColumns', function(){
    var model = new chartstack.Model({
      data: data
    })
      .addColumns([
        ['Drinks', 100, 200, 300, 400],
        ['Marketing', 200, 300, 400, 500]
      ]);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas", "Drinks", "Marketing"],
      ["2004",  1000,      400,     500,      100,      200],
      ["2005",  1170,      460,     400,      200,      300],
      ["2006",  660,       1120,    300,      300,      400],
      ["2007",  1030,      540,     200,      400,      500]
    ]);
  });

  it('.addColumns (before setting data)', function(){
    var model = new chartstack.Model({})
      .addColumns([
        ['Drinks', 100, 200, 300, 400],
        ['Marketing', 200, 300, 400, 500]
      ])
      .set(data);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas", "Drinks", "Marketing"],
      ["2004",  1000,      400,     500,      100,      200],
      ["2005",  1170,      460,     400,      200,      300],
      ["2006",  660,       1120,    300,      300,      400],
      ["2007",  1030,      540,     200,      400,      500]
    ]);
  });

  it('multiple transforms: .addColumns + .onlyRows + .addRows', function(){
    var model = new chartstack.Model({
      data: data
    })
      .addColumns([
        ['Drinks', 100, 200, 300, 400],
        ['Marketing', 200, 300, 400, 500]
      ])
      .onlyRows(['2004', '2006'])
      .addRows([['2030', 20, 40, 60, 80, 100]]);

    // Make sure global data didn't get polluted.
    expect(model.data).to.not.equal(data);

    expect(model.data).to.deep.equal([
      ["Year", "Sales", "Expenses", "Pizzas", "Drinks", "Marketing"],
      ["2004",  1000,      400,     500,      100,      200],
      ["2006",  660,       1120,    300,      300,      400],
      ["2030",  20,        40,      60,       80,       100]
    ]);
  });

  describe('adapter tests', function(){
    it('keen adapter test (multi-metric/piechart) conversion', function(done){
      var d = new chartstack.Model({
        url: '/api/keen/piechart.json',
        adapter: 'Keen IO'
      })

      d.on('update', function(){
        expect(d.data).to.deep.equal([
          ["platform", "result"],
          ["Mobile", 946],
          ["Web", 229]
        ]);
        done();
      });
      d.fetch();
    });

    it('keen adapter test (time-series/barchart) conversion', function(done){
      var d = new chartstack.Model({
        url: '/api/keen/barchart.json',
        adapter: 'Keen IO'
      })

      d.fetch()
        .on('update', function(){
          expect(d.data).to.deep.equal([
            ["date", "Mobile", "Web"],
            ["2014-03-04T07:00:00.000Z", 156, 31],
            ["2014-03-05T07:00:00.000Z", 111, 22],
            ["2014-03-06T07:00:00.000Z", 92, 31],
            ["2014-03-07T07:00:00.000Z", 152, 36]
          ]);
          done();
        });

    });
  });

  describe('adapter + transformation tests', function(){
    var d = window.bob = new chartstack.Model({
      url: '/api/keen/barchart.json',
      adapter: 'Keen IO'
    })
      .filterColumns(['Mobile']);

    it('keen adapter test w/ filter (Multi-time-series to time-series) conversion', function(done){
      d.fetch()
        .on('update', function(){
          expect(d.data).to.deep.equal([
            ["date", "Web"],
            ["2014-03-04T07:00:00.000Z", 31],
            ["2014-03-05T07:00:00.000Z", 22],
            ["2014-03-06T07:00:00.000Z", 31],
            ["2014-03-07T07:00:00.000Z", 36]
          ]);
          done();
        });
    });


    it('should allow resetting filter', function(done){
      d.reset();

      expect(d.data).to.deep.equal([
        ["date", "Mobile", "Web"],
        ["2014-03-04T07:00:00.000Z", 156, 31],
        ["2014-03-05T07:00:00.000Z", 111, 22],
        ["2014-03-06T07:00:00.000Z", 92, 31],
        ["2014-03-07T07:00:00.000Z", 152, 36]
      ]);
      done();
    });

  });
});
</script>
