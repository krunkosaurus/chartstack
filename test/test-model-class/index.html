---
layout: page
title: Test model class
test: true
---

<script src="../public/dist/chartstack2.min.js"></script>
<script>

var data = [
  ["Year", "Sales", "Expenses", "Pizzas"],
  ["2004",  1000,      400,     500],
  ["2005",  1170,      460,     400],
  ["2006",  660,       1120,    300],
  ["2007",  1030,      540,     200]
];

var pieData = [
  ["Browser", "Share"],
  ["Firefox", 45.0],
  ["IE", 26.8],
  ["Chrome", 12.8],
  ["Safari", 8.5],
  ["Opera", 6.2],
  ["Others", 0.7]
];

describe('model: direct injecting JSON data', function(){
  var d = new chartstack.Model({
    data: data
  });

  it('Should have raw data', function(){
    expect(d.data).to.deep.equal(data);
  });

  it('Chartstack model defaults: polling property should be there but false.', function(){
    expect(d.pollInterval).to.equal(0);
  });
});

describe('model: fetch data from url', function(){
  var d = new chartstack.Model({
    url: '/api/universal/piechart.json'
  })
    .fetch();

  it('Should have properly fetched data', function(done){
    d.on('update', function(){
      expect(d.data).to.deep.equal(pieData);
      done();
    });
    d.fetch();
  });
});

describe('model: injecting and polling url data', function(){
  var updateCount = 0;
  var stopCount;
  var d = new chartstack.Model({
    url: '/api/universal/piechart.json',
    pollInterval: 100
  });

  it('Should have data', function(done){
    d.on('update', function(){
      // console.log('updateCount', updateCount);
      updateCount = updateCount + 1;
      expect(d.data).to.deep.equal(pieData);
      done();
    });
    d.fetch();
  });

  it('Should be polling data', function(done){
    setTimeout(function(){
      stopCount = updateCount;
      expect(updateCount).to.be.above(2);
      d.stopPoll();
      done();
    },450);
  });

  it('Should have stopped polling', function(done){
    setTimeout(function(){
      expect(updateCount).to.equal(stopCount);
      done();
    },250);
  });
});

describe('test transforms with inline data', function(){
  it('.filterRows', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .filterRows(['2004', '2006'])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales", "Expenses", "Pizzas"],
          ["2005",  1170,      460,     400],
          ["2007",  1030,      540,     200]
        ]);
        done();
      });
  });

  it('.filterColumns', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .filterColumns(['Sales', 'Pizzas'])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year",  "Expenses"],
          ["2004",     400],
          ["2005",     460],
          ["2006",     1120],
          ["2007",     540]
        ]);
        done();
      });
  });

  it('.onlyRows', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .onlyRows(['2004', '2006'])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales", "Expenses", "Pizzas"],
          ["2004",  1000,      400,     500],
          ["2006",  660,       1120,    300]
        ]);
        done();
      });
  });


  it('.onlyColumns', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .onlyColumns(['Sales', 'Pizzas'])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales",  "Pizzas"],
          ["2004",  1000,    500],
          ["2005",  1170,    400],
          ["2006",  660,     300],
          ["2007",  1030,    200]
        ]);
        done();
      });
  });

  it('.addRows', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .addRows([
        ['2008', 100, 200, 300],
        ['2009', 200, 300, 400]
      ])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales", "Expenses", "Pizzas"],
          ["2004",  1000,      400,     500],
          ["2005",  1170,      460,     400],
          ["2006",  660,       1120,    300],
          ["2007",  1030,      540,     200],
          ['2008',  100,       200,     300],
          ['2009',  200,       300,     400]
        ]);
        done();
      });
  });

  it('.addColumns', function(done){
    var d = new chartstack.Model({
      data: data
    })
      .addColumns([
        ['Drinks', 100, 200, 300, 400],
        ['Marketing', 200, 300, 400, 500]
      ])
      .on('update', function(){
        expect(d.data).to.deep.equal([
          ["Year", "Sales", "Expenses", "Pizzas", "Drinks", "Marketing"],
          ["2004",  1000,      400,     500,      100,      200],
          ["2005",  1170,      460,     400,      200,      300],
          ["2006",  660,       1120,    300,      300,      400],
          ["2007",  1030,      540,     200,      400,      500]
        ]);
        done();
      });
  });
});


</script>
